module math

  use constants
  use random_lcg, only: prn

  implicit none

contains

!===============================================================================
! NORMAL_PERCENTILE calculates the percentile of the standard normal
! distribution with a specified probability level
!===============================================================================

  elemental function normal_percentile(p) result(z)

    real(8), intent(in) :: p ! probability level
    real(8)             :: z ! corresponding z-value

    real(8)            :: q
    real(8)            :: r
    real(8), parameter :: p_low  = 0.02425_8
    real(8), parameter :: a(6) = (/ &
         -3.969683028665376e1_8, 2.209460984245205e2_8, -2.759285104469687e2_8, &
         1.383577518672690e2_8, -3.066479806614716e1_8, 2.506628277459239e0_8 /)
    real(8), parameter :: b(5) = (/ &
         -5.447609879822406e1_8, 1.615858368580409e2_8, -1.556989798598866e2_8, &
         6.680131188771972e1_8, -1.328068155288572e1_8 /)
    real(8), parameter :: c(6) = (/ &
         -7.784894002430293e-3_8, -3.223964580411365e-1_8, -2.400758277161838_8, &
         -2.549732539343734_8, 4.374664141464968_8, 2.938163982698783_8 /)
    real(8), parameter :: d(4) = (/ &
         7.784695709041462e-3_8, 3.224671290700398e-1_8, &
         2.445134137142996_8,    3.754408661907416_8 /)

    ! The rational approximation used here is from an unpublished work at
    ! http://home.online.no/~pjacklam/notes/invnorm/

    if (p < p_low) then
      ! Rational approximation for lower region.

      q = sqrt(-TWO*log(p))
      z = (((((c(1)*q + c(2))*q + c(3))*q + c(4))*q + c(5))*q + c(6)) / &
           ((((d(1)*q + d(2))*q + d(3))*q + d(4))*q + ONE)

    elseif (p <= ONE - p_low) then
      ! Rational approximation for central region

      q = p - HALF
      r = q*q
      z = (((((a(1)*r + a(2))*r + a(3))*r + a(4))*r + a(5))*r + a(6))*q / &
           (((((b(1)*r + b(2))*r + b(3))*r + b(4))*r + b(5))*r + ONE)

    else
      ! Rational approximation for upper region

      q = sqrt(-TWO*log(ONE - p))
      z = -(((((c(1)*q + c(2))*q + c(3))*q + c(4))*q + c(5))*q + c(6)) / &
           ((((d(1)*q + d(2))*q + d(3))*q + d(4))*q + ONE)
    endif

    ! Refinement based on Newton's method
#ifndef NO_F2008
    z = z - (HALF * erfc(-z/sqrt(TWO)) - p) * sqrt(TWO*PI) * exp(HALF*z*z)
#endif

  end function normal_percentile

!===============================================================================
! T_PERCENTILE calculates the percentile of the Student's t distribution with a
! specified probability level and number of degrees of freedom
!===============================================================================

  elemental function t_percentile(p, df) result(t)

    real(8), intent(in) :: p  ! probability level
    integer, intent(in) :: df ! degrees of freedom
    real(8)             :: t  ! corresponding t-value

    real(8)            :: n  ! degrees of freedom as a real(8)
    real(8)            :: k  ! n - 2
    real(8)            :: z  ! percentile of normal distribution
    real(8)            :: z2 ! z * z

    if (df == 1) then
      ! For one degree of freedom, the t-distribution becomes a Cauchy
      ! distribution whose cdf we can invert directly

      t = tan(PI*(p - HALF))

    elseif (df == 2) then
      ! For two degrees of freedom, the cdf is given by 1/2 + x/(2*sqrt(x^2 +
      ! 2)). This can be directly inverted to yield the solution below

      t = TWO*sqrt(TWO)*(p - HALF)/sqrt(ONE - FOUR*(p - HALF)**2)

    else

      ! This approximation is from E. Olusegun George and Meenakshi Sivaram, "A
      ! modification of the Fisher-Cornish approximation for the student t
      ! percentiles," Communication in Statistics - Simulation and Computation,
      ! 16 (4), pp. 1123-1132 (1987).

      n = real(df,8)
      k = ONE/(n - TWO)
      z = normal_percentile(p)
      z2 = z * z
      t = sqrt(n*k) * (z + (z2 - THREE)*z*k/FOUR + ((5._8*z2 - 56._8)*z2 + &
           75._8)*z*k*k/96._8 + (((z2 - 27._8)*THREE*z2 + 417._8)*z2 - 315._8) &
           *z*k*k*k/384._8)

    end if

  end function t_percentile

!===============================================================================
! CALC_PN calculates the n-th order Legendre polynomial at the value of x.
! Since this function is called repeatedly during the neutron transport process,
! neither n or x is checked to see if they are in the applicable range.
! This is left to the client developer to use where applicable. x is to be in
! the domain of [-1,1], and 0<=n<=5. If x is outside of the range, the return
! value will be outside the expected range; if n is outside the stated range,
! the return value will be 1.0.
!===============================================================================

  elemental function calc_pn(n,x) result(pnx)

    integer, intent(in) :: n   ! Legendre order requested
    real(8), intent(in) :: x   ! Independent variable the Legendre is to be
                               ! evaluated at; x must be in the domain [-1,1]
    real(8)             :: pnx ! The Legendre poly of order n evaluated at x

    select case(n)
    case(1)
      pnx = x
    case(2)
      pnx = 1.5_8 * x * x - HALF
    case(3)
      pnx = 2.5_8 * x * x * x - 1.5_8 * x
    case(4)
      pnx = 4.375_8 * (x ** 4) - 3.75_8 * x * x + 0.375_8
    case(5)
      pnx = 7.875_8 * (x ** 5) - 8.75_8 * x * x * x + 1.875 * x
    case(6)
      pnx = 14.4375_8 * (x ** 6) - 19.6875_8 * (x ** 4) + &
           6.5625_8 * x * x - 0.3125_8
    case(7)
      pnx = 26.8125_8 * (x ** 7) - 43.3125_8 * (x ** 5) + &
           19.6875_8 * x * x * x - 2.1875_8 * x
    case(8)
      pnx = 50.2734375_8 * (x ** 8) - 93.84375_8 * (x ** 6) + &
           54.140625 * (x ** 4) - 9.84375_8 * x * x + 0.2734375_8
    case(9)
      pnx = 94.9609375_8 * (x ** 9) - 201.09375_8 * (x ** 7) + &
           140.765625_8 * (x ** 5) - 36.09375_8 * x * x * x + 2.4609375_8 * x
    case(10)
      pnx = 180.42578125_8 * (x ** 10) - 427.32421875_8 * (x ** 8) + &
           351.9140625_8 * (x ** 6) - 117.3046875_8 * (x ** 4) + &
           13.53515625_8 * x * x - 0.24609375_8
    case default
      pnx = ONE ! correct for case(0), incorrect for the rest
    end select

  end function calc_pn

!===============================================================================
! CALC_RN calculates the n-th order spherical harmonics for a given angle
! (in terms of (u,v,w)).  All Rn,m values are provided (where -n<=m<=n)
!===============================================================================

  pure function calc_rn(n,uvw) result(rn)

    integer, intent(in) :: n      ! Order requested
    real(8), intent(in) :: uvw(3) ! Direction of travel, assumed to be on unit sphere
    real(8)             :: rn(2*n + 1)     ! The resultant R_n(uvw)

    real(8) :: phi, w ! Azimuthal and Cosine of Polar angles (from uvw)
    real(8) :: w2m1   ! (w^2 - 1), frequently used in these

    w = uvw(3) ! z = cos(polar)
    if (uvw(1) == ZERO) then
      phi = ZERO
    else
      phi = atan2(uvw(2), uvw(1))
    end if

    w2m1 = (ONE - w**2)
    select case(n)
    case (0)
      ! l = 0, m = 0
      rn(1) = ONE
    case (1)
      ! l = 1, m = -1
      rn(1) = -(ONE*sqrt(w2m1) * sin(phi))
      ! l = 1, m = 0
      rn(2) = ONE * w
      ! l = 1, m = 1
      rn(3) = -(ONE*sqrt(w2m1) * cos(phi))
    case (2)
      ! l = 2, m = -2
      rn(1) = 0.288675134594813_8 * (-THREE * w**2 + THREE) * sin(TWO*phi)
      ! l = 2, m = -1
      rn(2) = -(1.73205080756888_8 * w*sqrt(w2m1) * sin(phi))
      ! l = 2, m = 0
      rn(3) = 1.5_8 * w**2 - HALF
      ! l = 2, m = 1
      rn(4) = -(1.73205080756888_8 * w*sqrt(w2m1) * cos(phi))
      ! l = 2, m = 2
      rn(5) = 0.288675134594813_8 * (-THREE * w**2 + THREE) * cos(TWO*phi)
    case (3)
      ! l = 3, m = -3
      rn(1) = -(0.790569415042095_8 * (w2m1)**(THREE/TWO) * sin(THREE * phi))
      ! l = 3, m = -2
      rn(2) = 1.93649167310371_8 * w*(w2m1) * sin(TWO*phi)
      ! l = 3, m = -1
      rn(3) = -(0.408248290463863_8*sqrt(w2m1)*((15.0_8/TWO)*w**2 - THREE/TWO) * &
           sin(phi))
      ! l = 3, m = 0
      rn(4) = 2.5_8 * w**3 - 1.5_8 * w
      ! l = 3, m = 1
      rn(5) = -(0.408248290463863_8*sqrt(w2m1)*((15.0_8/TWO)*w**2 - THREE/TWO) * &
           cos(phi))
      ! l = 3, m = 2
      rn(6) = 1.93649167310371_8 * w*(w2m1) * cos(TWO*phi)
      ! l = 3, m = 3
      rn(7) = -(0.790569415042095_8 * (w2m1)**(THREE/TWO) * cos(THREE* phi))
    case (4)
      ! l = 4, m = -4
      rn(1) = 0.739509972887452_8 * (w2m1)**2 * sin(4.0_8*phi)
      ! l = 4, m = -3
      rn(2) = -(2.09165006633519_8 * w*(w2m1)**(THREE/TWO) * sin(THREE* phi))
      ! l = 4, m = -2
      rn(3) = 0.074535599249993_8 * (w2m1)*((105.0_8/TWO)*w**2 - 15.0_8/TWO) * &
           sin(TWO*phi)
      ! l = 4, m = -1
      rn(4) = -(0.316227766016838_8*sqrt(w2m1)*((35.0_8/TWO)*w**3 - 15.0_8/TWO*w)&
           * sin(phi))
      ! l = 4, m = 0
      rn(5) = 4.375_8 * w**4 - 3.75_8 * w**2 + 0.375_8
      ! l = 4, m = 1
      rn(6) = -(0.316227766016838_8*sqrt(w2m1)*((35.0_8/TWO)*w**3 - 15.0_8/TWO*w)&
           * cos(phi))
      ! l = 4, m = 2
      rn(7) = 0.074535599249993_8 * (w2m1)*((105.0_8/TWO)*w**2 - 15.0_8/TWO) * &
           cos(TWO*phi)
      ! l = 4, m = 3
      rn(8) = -(2.09165006633519_8 * w*(w2m1)**(THREE/TWO) * cos(THREE* phi))
      ! l = 4, m = 4
      rn(9) = 0.739509972887452_8 * (w2m1)**2 * cos(4.0_8*phi)
    case (5)
      ! l = 5, m = -5
      rn(1) = -(0.701560760020114_8 * (w2m1)**(5.0_8/TWO) * sin(5.0_8*phi))
      ! l = 5, m = -4
      rn(2) = 2.21852991866236_8 * w*(w2m1)**2 * sin(4.0_8*phi)
      ! l = 5, m = -3
      rn(3) = -(0.00996023841111995_8 * (w2m1)**(THREE/TWO)* &
           ((945.0_8 /TWO)*w**2 - 105.0_8/TWO) * sin(THREE*phi))
      ! l = 5, m = -2
      rn(4) = 0.0487950036474267_8 * (w2m1) &
           * ((315.0_8/TWO)*w**3 - 105.0_8/TWO*w) * sin(TWO*phi)
      ! l = 5, m = -1
      rn(5) = -(0.258198889747161_8*sqrt(w2m1)* &
           ((315.0_8/8.0_8)*w**4 - 105.0_8/4.0_8 * w**2 + 15.0_8/8.0_8) &
           * sin(phi))
      ! l = 5, m = 0
      rn(6) = 7.875_8 * w**5 - 8.75_8 * w**3 + 1.875_8 * w
      ! l = 5, m = 1
      rn(7) = -(0.258198889747161_8*sqrt(w2m1)* &
           ((315.0_8/8.0_8)*w**4 - 105.0_8/4.0_8 * w**2 + 15.0_8/8.0_8) &
           * cos(phi))
      ! l = 5, m = 2
      rn(8) = 0.0487950036474267_8 * (w2m1)* &
           ((315.0_8/TWO)*w**3 - 105.0_8/TWO*w) * cos(TWO*phi)
      ! l = 5, m = 3
      rn(9) = -(0.00996023841111995_8 * (w2m1)**(THREE/TWO)* &
           ((945.0_8 /TWO)*w**2 - 105.0_8/TWO) * cos(THREE*phi))
      ! l = 5, m = 4
      rn(10) = 2.21852991866236_8 * w*(w2m1)**2 * cos(4.0_8*phi)
      ! l = 5, m = 5
      rn(11) = -(0.701560760020114_8 * (w2m1)**(5.0_8/TWO) * cos(5.0_8* phi))
    case (6)
      ! l = 6, m = -6
      rn(1) = 0.671693289381396_8 * (w2m1)**3 * sin(6.0_8*phi)
      ! l = 6, m = -5
      rn(2) = -(2.32681380862329_8 * w*(w2m1)**(5.0_8/TWO) * sin(5.0_8*phi))
      ! l = 6, m = -4
      rn(3) = 0.00104990131391452_8 * (w2m1)**2 * &
           ((10395.0_8/TWO)*w**2 - 945.0_8/TWO) * sin(4.0_8*phi)
      ! l = 6, m = -3
      rn(4) = -(0.00575054632785295_8 * (w2m1)**(THREE/TWO) * &
           ((3465.0_8/TWO)*w**3 - 945.0_8/TWO*w) * sin(THREE*phi))
      ! l = 6, m = -2
      rn(5) = 0.0345032779671177_8 * (w2m1) * &
           ((3465.0_8/8.0_8)*w**4 - 945.0_8/4.0_8 * w**2 + 105.0_8/8.0_8) &
           * sin(TWO*phi)
      ! l = 6, m = -1
      rn(6) = -(0.218217890235992_8*sqrt(w2m1) * &
           ((693.0_8/8.0_8)*w**5- 315.0_8/4.0_8 * w**3 + (105.0_8/8.0_8)*w) &
           * sin(phi))
      ! l = 6, m = 0
      rn(7) = 14.4375_8 * w**6 - 19.6875_8 * w**4 + 6.5625_8 * w**2 - 0.3125_8
      ! l = 6, m = 1
      rn(8) = -(0.218217890235992_8*sqrt(w2m1) * &
           ((693.0_8/8.0_8)*w**5- 315.0_8/4.0_8 * w**3 + (105.0_8/8.0_8)*w) &
           * cos(phi))
      ! l = 6, m = 2
      rn(9) = 0.0345032779671177_8 * (w2m1) * &
           ((3465.0_8/8.0_8)*w**4 -945.0_8/4.0_8 * w**2 + 105.0_8/8.0_8) &
           * cos(TWO*phi)
      ! l = 6, m = 3
      rn(10) = -(0.00575054632785295_8 * (w2m1)**(THREE/TWO) * &
           ((3465.0_8/TWO)*w**3 - 945.0_8/TWO*w) * cos(THREE*phi))
      ! l = 6, m = 4
      rn(11) = 0.00104990131391452_8 * (w2m1)**2 * &
           ((10395.0_8/TWO)*w**2 - 945.0_8/TWO) * cos(4.0_8*phi)
      ! l = 6, m = 5
      rn(12) = -(2.32681380862329_8 * w*(w2m1)**(5.0_8/TWO) * cos(5.0_8*phi))
      ! l = 6, m = 6
      rn(13) = 0.671693289381396_8 * (w2m1)**3 * cos(6.0_8*phi)
    case (7)
      ! l = 7, m = -7
      rn(1) = -(0.647259849287749_8 * (w2m1)**(7.0_8/TWO) * sin(7.0_8*phi))
      ! l = 7, m = -6
      rn(2) = 2.42182459624969_8 * w*(w2m1)**3 * sin(6.0_8*phi)
      ! l = 7, m = -5
      rn(3) = -(9.13821798555235d-5*(w2m1)**(5.0_8/TWO)* &
                 ((135135.0_8/TWO)*w**2 - 10395.0_8/TWO) * sin(5.0_8*phi))
      ! l = 7, m = -4
      rn(4) = 0.000548293079133141_8 * (w2m1)**2* &
           ((45045.0_8/TWO)*w**3 - 10395.0_8/TWO*w) * sin(4.0_8*phi)
      ! l = 7, m = -3
      rn(5) = -(0.00363696483726654_8 * (w2m1)**(THREE/TWO)* &
                 ((45045.0_8/8.0_8)*w**4 - 10395.0_8/4.0_8 * w**2 + 945.0_8/8.0_8)* &
                 sin(THREE*phi))
      ! l = 7, m = -2
      rn(6) = 0.025717224993682_8 * (w2m1)* &
           ((9009.0_8/8.0_8)*w**5 -3465.0_8/4.0_8 * w**3 + (945.0_8/8.0_8)*w)* &
           sin(TWO*phi)
      ! l = 7, m = -1
      rn(7) = -(0.188982236504614_8*sqrt(w2m1)* &
                 ((3003.0_8/16.0_8)*w**6 - 3465.0_8/16.0_8 * w**4 + &
                 (945.0_8/16.0_8)*w**2 - 35.0_8/16.0_8) * sin(phi))
      ! l = 7, m = 0
      rn(8) = 26.8125_8 * w**7 - 43.3125_8 * w**5 + 19.6875_8 * w**3 -2.1875_8 &
           * w
      ! l = 7, m = 1
      rn(9) = -(0.188982236504614_8*sqrt(w2m1)* &
                 ((3003.0_8/16.0_8)*w**6 - 3465.0_8/16.0_8 * w**4 + &
                  (945.0_8/16.0_8)*w**2 - 35.0_8/16.0_8) * cos(phi))
      ! l = 7, m = 2
      rn(10) = 0.025717224993682_8 * (w2m1)* &
           ((9009.0_8/8.0_8)*w**5 -3465.0_8/4.0_8 * w**3 + (945.0_8/8.0_8)*w)* &
           cos(TWO*phi)
      ! l = 7, m = 3
      rn(11) = -(0.00363696483726654_8 * (w2m1)**(THREE/TWO)* &
                 ((45045.0_8/8.0_8)*w**4 - 10395.0_8/4.0_8 * w**2 + 945.0_8/8.0_8)* &
                 cos(THREE*phi))
      ! l = 7, m = 4
      rn(12) = 0.000548293079133141_8 * (w2m1)**2 * &
           ((45045.0_8/TWO)*w**3 - 10395.0_8/TWO*w) * cos(4.0_8*phi)
      ! l = 7, m = 5
      rn(13) = -(9.13821798555235d-5*(w2m1)**(5.0_8/TWO)* &
                 ((135135.0_8/TWO)*w**2 - 10395.0_8/TWO) * cos(5.0_8*phi))
      ! l = 7, m = 6
      rn(14) = 2.42182459624969_8 * w*(w2m1)**3 * cos(6.0_8*phi)
      ! l = 7, m = 7
      rn(15) = -(0.647259849287749_8 * (w2m1)**(7.0_8/TWO) * cos(7.0_8*phi))
    case (8)
      ! l = 8, m = -8
      rn(1) = 0.626706654240044_8 * (w2m1)**4 * sin(8.0_8*phi)
      ! l = 8, m = -7
      rn(2) = -(2.50682661696018_8 * w*(w2m1)**(7.0_8/TWO) * sin(7.0_8*phi))
      ! l = 8, m = -6
      rn(3) = 6.77369783729086d-6*(w2m1)**3* &
           ((2027025.0_8/TWO)*w**2 - 135135.0_8/TWO) * sin(6.0_8*phi)
      ! l = 8, m = -5
      rn(4) = -(4.38985792528482d-5*(w2m1)**(5.0_8/TWO)* &
                 ((675675.0_8/TWO)*w**3 - 135135.0_8/TWO*w) * sin(5.0_8*phi))
      ! l = 8, m = -4
      rn(5) = 0.000316557156832328_8 * (w2m1)**2* &
           ((675675.0_8/8.0_8)*w**4 - 135135.0_8/4.0_8 * w**2 &
           + 10395.0_8/8.0_8) * sin(4.0_8*phi)
      ! l = 8, m = -3
      rn(6) = -(0.00245204119306875_8 * (w2m1)**(THREE/TWO)* &
                 ((135135.0_8/8.0_8)*w**5 - 45045.0_8/4.0_8 * w**3 &
                 + (10395.0_8/8.0_8)*w) * sin(THREE*phi))
      ! l = 8, m = -2
      rn(7) = 0.0199204768222399_8 * (w2m1)* &
           ((45045.0_8/16.0_8)*w**6- 45045.0_8/16.0_8 * w**4 + &
           (10395.0_8/16.0_8)*w**2 - 315.0_8/16.0_8) * sin(TWO*phi)
      ! l = 8, m = -1
      rn(8) = -(0.166666666666667_8*sqrt(w2m1)* &
                 ((6435.0_8/16.0_8)*w**7 - 9009.0_8/16.0_8 * w**5 + &
                 (3465.0_8/16.0_8)*w**3 - 315.0_8/16.0_8 * w) * sin(phi))
      ! l = 8, m = 0
      rn(9) = 50.2734375_8 * w**8 - 93.84375_8 * w**6 + 54.140625_8 * w**4 -&
           9.84375_8 * w**2 + 0.2734375_8
      ! l = 8, m = 1
      rn(10) = -(0.166666666666667_8*sqrt(w2m1)* &
                 ((6435.0_8/16.0_8)*w**7 - 9009.0_8/16.0_8 * w**5 + &
                 (3465.0_8/16.0_8)*w**3 - 315.0_8/16.0_8 * w) * cos(phi))
      ! l = 8, m = 2
      rn(11) = 0.0199204768222399_8 * (w2m1)*((45045.0_8/16.0_8)*w**6- &
           45045.0_8/16.0_8 * w**4 + (10395.0_8/16.0_8)*w**2 - &
           315.0_8/16.0_8) * cos(TWO*phi)
      ! l = 8, m = 3
      rn(12) = -(0.00245204119306875_8 * (w2m1)**(THREE/TWO)* &
                 ((135135.0_8/8.0_8)*w**5 - 45045.0_8/4.0_8 * w**3 + &
                 (10395.0_8/8.0_8)*w) * cos(THREE*phi))
      ! l = 8, m = 4
      rn(13) = 0.000316557156832328_8 * (w2m1)**2*((675675.0_8/8.0_8)*w**4 - &
           135135.0_8/4.0_8 * w**2 + 10395.0_8/8.0_8) * cos(4.0_8*phi)
      ! l = 8, m = 5
      rn(14) = -(4.38985792528482d-5*(w2m1)**(5.0_8/TWO)*((675675.0_8/TWO)*w**3 -&
                 135135.0_8/TWO*w) * cos(5.0_8*phi))
      ! l = 8, m = 6
      rn(15) = 6.77369783729086d-6*(w2m1)**3*((2027025.0_8/TWO)*w**2 - &
           135135.0_8/TWO) * cos(6.0_8*phi)
      ! l = 8, m = 7
      rn(16) = -(2.50682661696018_8 * w*(w2m1)**(7.0_8/TWO) * cos(7.0_8*phi))
      ! l = 8, m = 8
      rn(17) = 0.626706654240044_8 * (w2m1)**4 * cos(8.0_8*phi)
    case (9)
      ! l = 9, m = -9
      rn(1) = -(0.609049392175524_8 * (w2m1)**(9.0_8/TWO) * sin(9.0_8*phi))
      ! l = 9, m = -8
      rn(2) = 2.58397773170915_8 * w*(w2m1)**4 * sin(8.0_8*phi)
      ! l = 9, m = -7
      rn(3) = -(4.37240315267812d-7*(w2m1)**(7.0_8/TWO)* &
                 ((34459425.0_8/TWO)*w**2 - 2027025.0_8/TWO) * sin(7.0_8*phi))
      ! l = 9, m = -6
      rn(4) = 3.02928976464514d-6*(w2m1)**3* &
           ((11486475.0_8/TWO)*w**3 - 2027025.0_8/TWO*w) * sin(6.0_8*phi)
      ! l = 9, m = -5
      rn(5) = -(2.34647776186144d-5*(w2m1)**(5.0_8/TWO)* &
                 ((11486475.0_8/8.0_8)*w**4 - 2027025.0_8/4.0_8 * w**2 + &
                 135135.0_8/8.0_8) * sin(5.0_8*phi))
      ! l = 9, m = -4
      rn(6) = 0.000196320414650061_8 * (w2m1)**2*((2297295.0_8/8.0_8)*w**5 - &
           675675.0_8/4.0_8 * w**3 + (135135.0_8/8.0_8)*w) * sin(4.0_8*phi)
      ! l = 9, m = -3
      rn(7) = -(0.00173385495536766_8 * (w2m1)**(THREE/TWO)* &
                 ((765765.0_8/16.0_8)*w**6 - 675675.0_8/16.0_8 * w**4 + &
                 (135135.0_8/16.0_8)*w**2 - 3465.0_8/16.0_8) * sin(THREE*phi))
      ! l = 9, m = -2
      rn(8) = 0.0158910431540932_8 * (w2m1)*((109395.0_8/16.0_8)*w**7- &
           135135.0_8/16.0_8 * w**5 + (45045.0_8/16.0_8)*w**3 &
           - 3465.0_8/16.0_8 * w) * sin(TWO*phi)
      ! l = 9, m = -1
      rn(9) = -(0.149071198499986_8*sqrt(w2m1)*((109395.0_8/128.0_8)*w**8 - &
                 45045.0_8/32.0_8 * w**6 + (45045.0_8/64.0_8)*w**4 - 3465.0_8/32.0_8 &
                 * w**2 + 315.0_8/128.0_8) * sin(phi))
      ! l = 9, m = 0
      rn(10) = 94.9609375_8 * w**9 - 201.09375_8 * w**7 + 140.765625_8 * w**5- &
           36.09375_8 * w**3 + 2.4609375_8 * w
      ! l = 9, m = 1
      rn(11) = -(0.149071198499986_8*sqrt(w2m1)*((109395.0_8/128.0_8)*w**8 - &
                 45045.0_8/32.0_8 * w**6 + (45045.0_8/64.0_8)*w**4 -3465.0_8/32.0_8 &
                 * w**2 + 315.0_8/128.0_8) * cos(phi))
      ! l = 9, m = 2
      rn(12) = 0.0158910431540932_8 * (w2m1)*((109395.0_8/16.0_8)*w**7 - &
           135135.0_8/16.0_8 * w**5 + (45045.0_8/16.0_8)*w**3 &
           - 3465.0_8/ 16.0_8 * w) * cos(TWO*phi)
      ! l = 9, m = 3
      rn(13) = -(0.00173385495536766_8 * (w2m1)**(THREE/TWO)*((765765.0_8/16.0_8)&
                 *w**6 - 675675.0_8/16.0_8 * w**4 + (135135.0_8/16.0_8)*w**2 &
                 - 3465.0_8/16.0_8)* cos(THREE*phi))
      ! l = 9, m = 4
      rn(14) = 0.000196320414650061_8 * (w2m1)**2*((2297295.0_8/8.0_8)*w**5 - &
           675675.0_8/4.0_8 * w**3 + (135135.0_8/8.0_8)*w) * cos(4.0_8*phi)
      ! l = 9, m = 5
      rn(15) = -(2.34647776186144d-5*(w2m1)**(5.0_8/TWO)*((11486475.0_8/8.0_8)* &
                 w**4 - 2027025.0_8/4.0_8 * w**2 + 135135.0_8/8.0_8) * cos(5.0_8*phi))
      ! l = 9, m = 6
      rn(16) = 3.02928976464514d-6*(w2m1)**3*((11486475.0_8/TWO)*w**3 - &
           2027025.0_8/TWO*w) * cos(6.0_8*phi)
      ! l = 9, m = 7
      rn(17) = -(4.37240315267812d-7*(w2m1)**(7.0_8/TWO)* &
                 ((34459425.0_8/TWO)*w**2 - 2027025.0_8/TWO) * cos(7.0_8*phi))
      ! l = 9, m = 8
      rn(18) = 2.58397773170915_8 * w*(w2m1)**4 * cos(8.0_8*phi)
      ! l = 9, m = 9
      rn(19) = -(0.609049392175524_8 * (w2m1)**(9.0_8/TWO) * cos(9.0_8*phi))
    case (10)
      ! l = 10, m = -10
      rn(1) = 0.593627917136573_8 * (w2m1)**5 * sin(10.0_8*phi)
      ! l = 10, m = -9
      rn(2) = -(2.65478475211798_8 * w*(w2m1)**(9.0_8/TWO) * sin(9.0_8*phi))
      ! l = 10, m = -8
      rn(3) = 2.49953651452314d-8*(w2m1)**4*((654729075.0_8/TWO)*w**2 - &
           34459425.0_8/TWO) * sin(8.0_8*phi)
      ! l = 10, m = -7
      rn(4) = -(1.83677671621093d-7*(w2m1)**(7.0_8/TWO)* &
                 ((218243025.0_8/TWO)*w**3 - 34459425.0_8/TWO*w) * sin(7.0_8*phi))
      ! l = 10, m = -6
      rn(5) = 1.51464488232257d-6*(w2m1)**3*((218243025.0_8/8.0_8)*w**4 - &
           34459425.0_8/4.0_8 * w**2 + 2027025.0_8/8.0_8) * sin(6.0_8*phi)
      ! l = 10, m = -5
      rn(6) = -(1.35473956745817d-5*(w2m1)**(5.0_8/TWO)* &
                 ((43648605.0_8/8.0_8)*w**5 - 11486475.0_8/4.0_8 * w**3 + &
                 (2027025.0_8/8.0_8)*w) * sin(5.0_8*phi))
      ! l = 10, m = -4
      rn(7) = 0.000128521880085575_8 * (w2m1)**2*((14549535.0_8/16.0_8)*w**6 - &
           11486475.0_8/16.0_8 * w**4 + (2027025.0_8/16.0_8)*w**2 - &
           45045.0_8/16.0_8) * sin(4.0_8*phi)
      ! l = 10, m = -3
      rn(8) = -(0.00127230170115096_8 * (w2m1)**(THREE/TWO)* &
                 ((2078505.0_8/16.0_8)*w**7 - 2297295.0_8/16.0_8 * w**5 + &
                 (675675.0_8/16.0_8)*w**3 - 45045.0_8/16.0_8 * w) * sin(THREE*phi))
      ! l = 10, m = -2
      rn(9) = 0.012974982402692_8 * (w2m1)*((2078505.0_8/128.0_8)*w**8 - &
           765765.0_8/32.0_8 * w**6 + (675675.0_8/64.0_8)*w**4 - &
           45045.0_8/32.0_8 * w**2 + 3465.0_8/128.0_8) * sin(TWO*phi)
      ! l = 10, m = -1
      rn(10) = -(0.134839972492648_8*sqrt(w2m1)*((230945.0_8/128.0_8)*w**9 - &
                 109395.0_8/32.0_8 * w**7 + (135135.0_8/64.0_8)*w**5 - &
                 15015.0_8/32.0_8 * w**3 + (3465.0_8/128.0_8)*w) * sin(phi))
      ! l = 10, m = 0
      rn(11) = 180.42578125_8 * w**10 - 427.32421875_8 * w**8 +351.9140625_8 &
           * w**6 - 117.3046875_8 * w**4 + 13.53515625_8 * w**2 -0.24609375_8
      ! l = 10, m = 1
      rn(12) = -(0.134839972492648_8*sqrt(w2m1)*((230945.0_8/128.0_8)*w**9 - &
                 109395.0_8/32.0_8 * w**7 + (135135.0_8/64.0_8)*w**5 -15015.0_8/ &
                 32.0_8 * w**3 + (3465.0_8/128.0_8)*w) * cos(phi))
      ! l = 10, m = 2
      rn(13) = 0.012974982402692_8 * (w2m1)*((2078505.0_8/128.0_8)*w**8 - &
           765765.0_8/32.0_8 * w**6 + (675675.0_8/64.0_8)*w**4 -&
           45045.0_8/32.0_8 * w**2 + 3465.0_8/128.0_8) * cos(TWO*phi)
      ! l = 10, m = 3
      rn(14) = -(0.00127230170115096_8 * (w2m1)**(THREE/TWO)* &
                 ((2078505.0_8/16.0_8)*w**7 - 2297295.0_8/16.0_8 * w**5 + &
                 (675675.0_8/16.0_8)*w**3 - 45045.0_8/16.0_8 * w) * cos(THREE*phi))
      ! l = 10, m = 4
      rn(15) = 0.000128521880085575_8 * (w2m1)**2*((14549535.0_8/16.0_8)*w**6 -&
           11486475.0_8/16.0_8 * w**4 + (2027025.0_8/16.0_8)*w**2 - &
           45045.0_8/16.0_8) * cos(4.0_8*phi)
      ! l = 10, m = 5
      rn(16) = -(1.35473956745817d-5*(w2m1)**(5.0_8/TWO)* &
                 ((43648605.0_8/8.0_8)*w**5 - 11486475.0_8/4.0_8 * w**3 + &
                 (2027025.0_8/8.0_8)*w) * cos(5.0_8*phi))
      ! l = 10, m = 6
      rn(17) = 1.51464488232257d-6*(w2m1)**3*((218243025.0_8/8.0_8)*w**4 - &
           34459425.0_8/4.0_8 * w**2 + 2027025.0_8/8.0_8) * cos(6.0_8*phi)
      ! l = 10, m = 7
      rn(18) = -(1.83677671621093d-7*(w2m1)**(7.0_8/TWO)* &
                 ((218243025.0_8/TWO)*w**3 - 34459425.0_8/TWO*w) * cos(7.0_8*phi))
      ! l = 10, m = 8
      rn(19) = 2.49953651452314d-8*(w2m1)**4* &
           ((654729075.0_8/TWO)*w**2 - 34459425.0_8/TWO) * cos(8.0_8*phi)
      ! l = 10, m = 9
      rn(20) = -(2.65478475211798_8 * w*(w2m1)**(9.0_8/TWO) * cos(9.0_8*phi))
      ! l = 10, m = 10
      rn(21) = 0.593627917136573_8 * (w2m1)**5 * cos(10.0_8*phi)
    case default
      rn = ONE
    end select

  end function calc_rn

!===============================================================================
! MAXWELL_SPECTRUM samples an energy from the Maxwell fission distribution based
! on a direct sampling scheme. The probability distribution function for a
! Maxwellian is given as p(x) = 2/(T*sqrt(pi))*sqrt(x/T)*exp(-x/T). This PDF can
! be sampled using rule C64 in the Monte Carlo Sampler LA-9721-MS.
!===============================================================================

  function maxwell_spectrum(T) result(E_out)

    real(8), intent(in)  :: T     ! tabulated function of incoming E
    real(8)              :: E_out ! sampled energy

    real(8) :: r1, r2, r3  ! random numbers
    real(8) :: c           ! cosine of pi/2*r3

    r1 = prn()
    r2 = prn()
    r3 = prn()

    ! determine cosine of pi/2*r
    c = cos(PI/TWO*r3)

    ! determine outgoing energy
    E_out = -T*(log(r1) + log(r2)*c*c)

  end function maxwell_spectrum

!===============================================================================
! WATT_SPECTRUM samples the outgoing energy from a Watt energy-dependent fission
! spectrum. Although fitted parameters exist for many nuclides, generally the
! continuous tabular distributions (LAW 4) should be used in lieu of the Watt
! spectrum. This direct sampling scheme is an unpublished scheme based on the
! original Watt spectrum derivation (See F. Brown's MC lectures).
!===============================================================================

  function watt_spectrum(a, b) result(E_out)

    real(8), intent(in) :: a     ! Watt parameter a
    real(8), intent(in) :: b     ! Watt parameter b
    real(8)             :: E_out ! energy of emitted neutron

    real(8) :: w ! sampled from Maxwellian

    w     = maxwell_spectrum(a)
    E_out = w + a*a*b/4. + (TWO*prn() - ONE)*sqrt(a*a*b*w)

  end function watt_spectrum
  
!==============================================================================
! gauss_legendre_integral_define
! gauss_integral value
!==============================================================================
subroutine Gauss_Legendre_Integral_Define(N,X,WTT,A,B)
IMPLICIT NONE
!PASSED IN
INTEGER :: N
REAL(8) :: X(N),WTT(N)
REAL(8) :: A,B
!IF(B-A .LE. 1.0D-10)WRITE(*,10)
SELECTCASE(N)
CASE(1)
   X=(/0.0D0/)
 WTT=(/2.0D0/)
CASE(2)
   X=(/-0.577350269189626D0,0.577350269189626D0/)
 WTT=(/1.0D0,1.0D0/)
CASE(3)
   X=(/0.0D0,0.774596669241483D0,-0.774596669241483D0/)
 WTT=(/0.888888888888889D0,0.555555555555556D0,0.555555555555556D0/)
CASE(4)
   X=(/-0.861136311594054D0,0.861136311594053D0,-0.339981043584857D0,0.339981043584856D0/)
 WTT=(/0.347854845137453D0,0.347854845137454D0,0.652145154862548D0,0.652145154862546D0/)
CASE(5)
   X=(/0.0D0,-0.906179845938664D0,-0.538469310105683D0,0.906179845938664D0,0.538469310105683D0/)
 WTT=(/0.568888888888889D0,0.236926885056189D0,0.478628670499367D0,0.236926885056189D0,0.478628670499366D0/)
CASE(6)
   X=(/-0.932469514203153D0,-0.661209386466264D0, 0.932469514203154D0,&
        0.661209386466263D0,-0.238619186083197D0, 0.238619186083197D0/)
 WTT=(/ 0.171324492379170D0, 0.360761573048140D0, 0.171324492379169D0,&
        0.360761573048142D0, 0.467913934572691D0, 0.467913934572689D0/)
CASE(7)
   X=(/0.0D0,-0.949107912342760D0,-0.741531185599394D0,-0.405845151377397D0,&
       0.949107912342760D0, 0.741531185599394D0, 0.405845151377397D0/)
 WTT=(/ 0.417959183673471D0, 0.129484966168868D0, 0.279705391489280D0, 0.381830050505116D0,&
        0.129484966168868D0, 0.279705391489279D0, 0.381830050505117D0/)
CASE(8)
   X=(/-0.960289856497540D0,-0.796666477413625D0, 0.960289856497543D0, 0.796666477413622D0,&
       -0.525532409916329D0, 0.525532409916331D0,-0.183434642495650D0, 0.183434642495650D0/)
 WTT=(/ 0.101228536290374D0, 0.222381034453380D0, 0.101228536290371D0, 0.222381034453387D0,&
        0.313706645877885D0, 0.313706645877876D0, 0.362683783378362D0, 0.362683783378369D0/)
CASE(9)
   X=(/0.0D0,-0.968160239507629D0,-0.836031107326635D0,-0.613371432700590D0,-0.324253423403809D0,&
       0.968160239507627D0, 0.836031107326636D0, 0.613371432700589D0, 0.324253423403809D0/)
 WTT=(/0.330239355001244D0, 0.081274388361571D0, 0.180648160694865D0, 0.260610696402927D0, 0.312347077040017D0,&
       0.081274388361572D0, 0.180648160694863D0, 0.260610696402930D0, 0.312347077040010D0/)
CASE(10)
   X=(/-0.973906528517167D0,-0.865063366688989D0,-0.679409568299026D0,&
        0.973906528517167D0, 0.865063366688989D0, 0.679409568299024D0,&
       -0.433395394129247D0, 0.433395394129247D0,-0.148874338981631D0,&
        0.148874338981631D0/)
 WTT=(/ 0.066671344308692D0, 0.149451349150569D0, 0.219086362515991D0,&
        0.066671344308692D0, 0.149451349150571D0, 0.219086362515994D0,&
        0.269266719309985D0, 0.269266719309985D0, 0.295524224714756D0,&
        0.295524224714752D0/)
CASE(11)
   X=(/               0.0D0,-0.978228658146066D0,-0.887062599768081D0,&
       -0.730152005574056D0,-0.519096129206811D0,-0.269543155952345D0,&
        0.978228658146069D0, 0.887062599768080D0, 0.730152005574051D0,&
        0.519096129206813D0, 0.269543155952345D0/)
 WTT=(/ 0.272925086777914D0, 0.055668567116171D0, 0.125580369464934D0,&
        0.186290210927672D0, 0.233193764592036D0, 0.262804544510188D0,&
        0.055668567116163D0, 0.125580369464934D0, 0.186290210927701D0,&
        0.233193764592006D0, 0.262804544510234D0/)
CASE(12)
   X=(/-0.981560634246711D0,-0.904117256370481D0,-0.769902674194304D0,&
        0.981560634246710D0, 0.904117256370496D0, 0.769902674194296D0,&
       -0.587317954286618D0, 0.587317954286619D0,-0.367831498998180D0,&
        0.367831498998180D0,-0.125233408511469D0, 0.125233408511469D0/)
 WTT=(/ 0.047175336386518D0, 0.106939325995302D0, 0.160078328543365D0,&
        0.047175336386512D0, 0.106939325995299D0, 0.160078328543401D0,&
        0.203167426723102D0, 0.203167426723024D0, 0.233492536538330D0,&
        0.233492536538400D0, 0.249147045813417D0, 0.249147045813375D0/)
CASE(13)
   X=(/               0.0D0,-0.984183054718593D0,-0.917598399222953D0,&
       -0.801578090733328D0,-0.642349339440337D0,-0.448492751036446D0,&
        0.984183054718619D0, 0.917598399222926D0, 0.801578090733337D0,&
       -0.230458315955135D0, 0.642349339440337D0, 0.448492751036444D0,&
        0.230458315955135D0/)
 WTT=(/ 0.232551553231114D0, 0.040484004765308D0, 0.092121499837757D0,&
        0.138873510219656D0, 0.178145980762106D0, 0.207816047536406D0,&
        0.040484004765304D0, 0.092121499837772D0, 0.138873510219698D0,&
        0.226283180262542D0, 0.178145980761948D0, 0.207816047536943D0,&
        0.226283180262772D0/)
CASE(14)
   X=(/-0.986283808696730D0,-0.928434883663749D0,-0.827201315069634D0,&
       -0.687292904811720D0, 0.986283808696780D0, 0.928434883663662D0,&
        0.827201315069682D0, 0.687292904811718D0,-0.515248636358160D0,&
        0.515248636358156D0,-0.319112368927886D0, 0.319112368927887D0,&
       -0.108054948707344D0, 0.108054948707344D0/)
 WTT=(/ 0.035119460331766D0, 0.080158087159573D0, 0.121518570688355D0,&
        0.157203167157899D0, 0.035119460331739D0, 0.080158087159738D0,&
        0.121518570688090D0, 0.157203167158056D0, 0.185538397478244D0,&
        0.185538397478106D0, 0.205198463721116D0, 0.205198463721245D0,&
        0.215263853463230D0, 0.215263853463182D0/)
CASE(15)
   X=(/               0.0D0,-0.987992518020629D0,-0.937273392400469D0,&
       -0.848206583410548D0,-0.724417731360129D0,-0.570972172608559D0,&
       -0.394151347077558D0, 0.987992518020615D0, 0.937273392400454D0,&
        0.848206583410595D0, 0.724417731360107D0,-0.201194093997435D0,&
        0.570972172608563D0, 0.394151347077558D0, 0.201194093997435D0/)
 WTT=(/ 0.202578241924909D0, 0.030753241996009D0, 0.070366047488290D0,&
        0.107159220466449D0, 0.139570677926114D0, 0.166269205816452D0,&
        0.186161000018164D0, 0.030753241996130D0, 0.070366047488312D0,&
        0.107159220466914D0, 0.139570677926405D0, 0.198431485328291D0,&
        0.166269205816874D0, 0.186161000015303D0, 0.198431485327478D0/)
CASE(16)
   X=(/-0.989400934991190D0,-0.944575023074230D0,-0.865631202387035D0,&
       -0.755404408355321D0,-0.617876244402582D0, 0.989400934990938D0,&
        0.944575023074742D0, 0.865631202386633D0, 0.755404408355496D0,&
        0.617876244402541D0,-0.458016777657231D0, 0.458016777657235D0,&
       -0.281603550779258D0, 0.281603550779259D0,-0.095012509837637D0,&
        0.095012509837638D0/)
 WTT=(/ 0.027152459411754D0, 0.062253523937935D0, 0.095158511684623D0,&
        0.124628971253292D0, 0.149595988818626D0, 0.027152459411846D0,&
        0.062253523937347D0, 0.095158511685614D0, 0.124628971252073D0,&
        0.149595988819313D0, 0.169156519393693D0, 0.169156519393260D0,&
        0.182603415045375D0, 0.182603415046232D0, 0.189450610455199D0,&
        0.189450610454461D0/)
CASE(17)
   X=(/               0.0D0,-0.990575475313836D0,-0.950675521770044D0,&
       -0.880239153725940D0,-0.781514003897233D0,-0.657671159216619D0,&
       -0.512690537086464D0,-0.351231763453882D0, 0.990575475313918D0,&
        0.950675521769763D0, 0.880239153726331D0, 0.781514003896956D0,&
        0.657671159216716D0, 0.512690537086447D0,-0.178484181495847D0,&
        0.351231763453885D0, 0.178484181495848D0/)
 WTT=(/ 0.179446470342357D0, 0.024148302868968D0, 0.055459529372477D0,&
        0.085036148325217D0, 0.111883847189377D0, 0.135136368453913D0,&
        0.154045761081641D0, 0.168004102185740D0, 0.024148302868660D0,&
        0.055459529373719D0, 0.085036148316893D0, 0.111883847195567D0,&
        0.135136368464808D0, 0.154045761082600D0, 0.176562705383976D0,&
        0.168004102147596D0, 0.176562705378259D0/)
CASE(18)
   X=(/-0.991565168421074D0,-0.955823949571093D0,-0.892602466497863D0,&
       -0.803704958972190D0,-0.691687043060677D0, 0.991565168420992D0,&
        0.955823949571245D0, 0.892602466497820D0, 0.803704958972108D0,&
        0.691687043060751D0,-0.559770831073767D0, 0.559770831073746D0,&
       -0.411751161462888D0, 0.411751161462890D0,-0.251886225691502D0,&
        0.251886225691502D0,-0.084775013041735D0, 0.084775013041735D0/)
 WTT=(/ 0.021616013526634D0, 0.049714548894990D0, 0.076425730254688D0,&
        0.100942044106863D0, 0.122555206710897D0, 0.021616013526381D0,&
        0.049714548894450D0, 0.076425730254810D0, 0.100942044105877D0,&
        0.122555206711428D0, 0.140642914671149D0, 0.140642914673245D0,&
        0.154684675126902D0, 0.154684675124497D0, 0.164276483745916D0,&
        0.164276483747133D0, 0.169142382963837D0, 0.169142382962944D0/)
CASE DEFAULT
   Write(*,20)
END SELECT
X=(X*(B-A)+(A+B))*0.5D0
WTT=WTT*(B-A)*0.5
!10 FORMAT("('[Gauss_Lengendre_Integral] ERROR: Wrong Integral region Define)")
20 FORMAT("('[Gauss_Lengendre_Integral] ERROR: Invalid number of Gauss points)")
END SUBROUTINE

end module math
